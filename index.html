<!DOCTYPE html>
<html lang="ja">
<head>
  <!--
  TRTãƒ»PRA ABMã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ v6.0 (ç ”ç©¶ç”¨å¼·åŒ–ç‰ˆ)
  ç›®çš„:
    - å†ç¾æ€§: ä¹±æ•°ã‚·ãƒ¼ãƒ‰å›ºå®šã€å®Ÿé¨“æ¡ä»¶ã®JSONä¿å­˜/å¾©å…ƒ
    - è¦³æ¸¬æ€§: çµ±è¨ˆãƒ¡ãƒˆãƒªã‚¯ã‚¹(æˆåŠŸç‡ãƒ»å¹³å‡æˆåŠŸæ™‚é–“ãƒ»åˆ†å¸ƒ)ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºã¨CSVå‡ºåŠ›
    - ãƒãƒƒãƒå®Ÿè¡Œ: ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ»è¤‡æ•°è©¦è¡Œ(ä¸¦åˆ—UIã€ç›´åˆ—å®Ÿè¡Œ)ã§ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ã‚¤ãƒ¼ãƒ—
    - è¼ƒæ­£ä¸‹åœ°: ç›®æ¨™KGI(ä¾‹: æˆåŠŸç‡13%)ã«å¯¾ã™ã‚‹ç›®çš„é–¢æ•°/èª¤å·®ã®å®šç¾©ã€æ¢ç´¢ãƒ«ãƒ¼ãƒ—ã®ãƒ•ãƒƒã‚¯(â€»GAæœ¬ä½“ã¯åˆ¥å®Ÿè£…æƒ³å®š)
    - UI/UX: å®Œå…¨ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã€ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã€ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã€ã‚·ãƒŠãƒªã‚ªç®¡ç†
    - å¯è¦–åŒ–ç©ºé–“: å††éŒç©ºé–“=å¤–å½¢ãƒ¡ãƒƒã‚·ãƒ¥(é€æ˜)ã®ã¿ã€å´ç·šãªã—ã€èŠ±ç«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç„¡ã—

  ODDè¦ç´„ (æ¦‚ç•¥):
    Purpose: ãƒã‚¤ã‚ªãƒ™ãƒ³ãƒãƒ£ãƒ¼å‰µè–¬æ´»å‹•ã‚’æŠ½è±¡åŒ–ã—ã€TRT(ç¸¦)Ã—PRA(æ¨ª)ã®ç›¸äº’ä½œç”¨ã¨çµ„ç¹”å½¢æ…‹(ä¸­å¤®é›†æ¨©/åˆ†æ•£/ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰)è¨­å®šãŒ
             ãƒã‚¯ãƒ­æˆæœ(æˆåŠŸç‡/æ™‚é–“)ã«ä¸ãˆã‚‹å½±éŸ¿ã‚’æ¤œè¨
    Entities: ç²’å­(è³‡æº)â€¦ type âˆˆ {standard, explorer, exploiter}, å±æ€§: trtAffinity, praAffinity, age, lifespan
    Processes: å„ã‚¿ã‚¤ãƒ ã‚¹ãƒ†ãƒƒãƒ—ã§TRTä¸Šæ˜‡åŠ›ãƒ»PRAæ¨ªç§»å‹•ãƒ»ä¸­å¤®åæŸãƒ»æ‘©æ“¦ãªã©æ±ºå®šè«–ï¼‹ç¢ºç‡(ã‚·ãƒ¼ãƒ‰ç®¡ç†)ã§æ›´æ–°
    Design concepts: è‡ªå¾‹ã€ç›¸äº’ä½œç”¨(è¿‘æ¥å¼•åŠ›)ã€ç¢ºç‡(æ¢ç´¢ã‚†ã‚‰ã)ã€é©å¿œ(ã‚¿ã‚¤ãƒ—å±æ€§)ã€é›†å›£æ§‹é€ (ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ä»®æƒ³)
    Initialization: ã‚·ãƒ¼ãƒ‰ã€åˆæœŸç²’å­æ•°ã€ã‚¿ã‚¤ãƒ—æ¯”ç‡ã€æˆ¦ç•¥çš„åˆæœŸé…ç½®ã‚ªãƒ³/ã‚ªãƒ•ç­‰
    Input/Output: UIæ“ä½œã€ã‚·ãƒŠãƒªã‚ªJSONã€ãƒ­ã‚°CSVã€ãƒãƒƒãƒè¨­å®šJSON

  é‡è¦: æœ¬ã‚³ãƒ¼ãƒ‰ã¯æ•™è‚²ãƒ»ç ”ç©¶ç”¨ã®é››å½¢ã§ã‚ã‚Šã€è¼ƒæ­£å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ãŒæœªæ¥ç¶šã®ãŸã‚ã€æ•°å€¤çµæœã¯ä»®ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‡ºåŠ›ã¨ã—ã¦æ‰±ã†ã“ã¨(ä½†ã—æ›¸ã)ã€‚
  -->

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TRTãƒ»PRA ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ v6.0 (ç ”ç©¶ç”¨å¼·åŒ–ç‰ˆ)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/three.min.js"></script>
  <style>
    :root {
      --bg:#f0f2f5; --panel:#fff; --shadow:0 4px 18px rgba(0,0,0,.12);
      --text:#1f2937; --muted:#6b7280; --accent:#3b82f6; --line:#e5e7eb;
    }
    html, body { margin:0; height:100%; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; }
    #app { display:flex; flex-direction:row; height:100%; width:100%; overflow:hidden; }
    #viewport { flex:1 1 auto; position:relative; min-width:0; }
    #sidebar { flex:0 0 380px; min-width:300px; max-width:480px; display:flex; flex-direction:column; gap:12px; padding:12px; border-left:1px solid var(--line); background:#f8fafb; overflow:auto; }
    .panel { background:var(--panel); border-radius:12px; box-shadow:var(--shadow); padding:16px; }
    h1 { font-size:18px; margin:0 0 8px; }
    h2 { font-size:14px; margin:14px 0 10px; padding-bottom:6px; border-bottom:1px solid var(--line); }
    .row { display:flex; gap:8px; flex-wrap:wrap; }
    .btn { background:var(--accent); color:#fff; border:none; border-radius:8px; padding:8px 12px; cursor:pointer; font-weight:600; }
    .btn.secondary { background:#64748b; }
    .btn.ghost { background:transparent; color:var(--accent); border:1px solid var(--accent); }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .grid { display:grid; grid-template-columns: 1fr 88px; gap:8px 10px; align-items:center; }
    label { font-size:12px; color:#374151; display:flex; align-items:center; gap:6px; }
    .value { font-size:12px; color:var(--muted); text-align:right; }
    input[type="range"]{ width:100%; }
    input[type="number"], input[type="text"] { width:100%; padding:6px 8px; border:1px solid var(--line); border-radius:6px; }
    .help { font-size:11px; color:var(--muted); }
    .tooltip { position:relative; cursor:help; }
    .tooltip .tip {
      position:absolute; z-index:10; left:50%; transform:translateX(-50%);
      bottom:125%; background:#111; color:#fff; border-radius:8px; padding:10px 12px;
      width:280px; font-size:12px; box-shadow:0 6px 20px rgba(0,0,0,.2);
      opacity:0; visibility:hidden; transition:.2s ease;
    }
    .tooltip:hover .tip { opacity:1; visibility:visible; }
    .stat { display:flex; justify-content:space-between; margin:6px 0; font-size:12px; }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background:#f3f4f6; border:1px solid var(--line); border-radius:8px; padding:10px; }
    @media (max-width: 1024px) {
      #app{flex-direction:column;}
      #sidebar{order:2; max-height:45vh;}
      #viewport{order:1; height:55vh;}
    }
    @media (max-width: 640px) {
      #sidebar{max-height:52vh;}
      .grid{grid-template-columns: 1fr 72px;}
    }
    /* a11y focus */
    .btn:focus, input:focus { outline:2px solid #2563eb; outline-offset:2px; }
  </style>
</head>
<body>
<div id="app" role="application" aria-label="TRTãƒ»PRA ABMã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒ">
  <div id="viewport" aria-label="3Dè¡¨ç¤ºé ˜åŸŸ"></div>
  <aside id="sidebar" aria-label="æ“ä½œãƒ‘ãƒãƒ«">
    <section class="panel">
      <h1>TRTãƒ»PRA ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ v6.0</h1>
      <div class="help">ç ”ç©¶ç”¨å¼·åŒ–: å†ç¾æ€§(ã‚·ãƒ¼ãƒ‰)ã€CSVå‡ºåŠ›ã€ãƒãƒƒãƒã€ã‚·ãƒŠãƒªã‚ªJSONã€ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã€èŠ±ç«ç„¡[1]</div>
      <div class="row" style="margin-top:8px;">
        <button class="btn" id="btnStart">é–‹å§‹</button>
        <button class="btn secondary" id="btnPause">ä¸€æ™‚åœæ­¢</button>
        <button class="btn ghost" id="btnReset">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <button class="btn" id="btnExportCSV">CSVå‡ºåŠ›</button>
        <button class="btn ghost" id="btnExportJSON">ã‚·ãƒŠãƒªã‚ªä¿å­˜</button>
        <label class="btn ghost" for="fileImport" style="display:inline-flex; align-items:center;">ã‚·ãƒŠãƒªã‚ªèª­è¾¼</label>
        <input id="fileImport" type="file" accept=".json" style="display:none;">
      </div>
    </section>

    <section class="panel">
      <h2>å†ç¾æ€§ãƒ»æ™‚é–“</h2>
      <div class="grid">
        <label>ä¹±æ•°ã‚·ãƒ¼ãƒ‰ <span class="tooltip">ğŸ›ˆ<span class="tip">å†ç¾æ€§ã®ãŸã‚å›ºå®šã‚·ãƒ¼ãƒ‰ã§å…¨ç¢ºç‡éç¨‹ã‚’åˆ¶å¾¡ã—ã¾ã™[1]</span></span></label>
        <input type="number" id="seed" value="123456" step="1" min="0">
        <label>æ™‚é–“ã‚¹ã‚±ãƒ¼ãƒ«</label><div class="value" id="val_timeScale">0.10</div>
        <input type="range" id="timeScale" min="0.01" max="1.0" step="0.01" value="0.10"><div></div>
        <label>ç™ºç”Ÿé–“éš”</label><div class="value" id="val_spawnInterval">0.50</div>
        <input type="range" id="spawnInterval" min="0.1" max="2.0" step="0.1" value="0.50"><div></div>
        <label>ãƒãƒƒãƒã‚µã‚¤ã‚º</label><div class="value" id="val_batchSize">3</div>
        <input type="range" id="batchSize" min="1" max="20" step="1" value="3"><div></div>
        <label>åˆæœŸç²’å­æ•°</label><div class="value" id="val_initialParticles">20</div>
        <input type="range" id="initialParticles" min="0" max="200" step="5" value="20"><div></div>
      </div>
    </section>

    <section class="panel">
      <h2>è³‡æºç‰¹æ€§ãƒ»ã‚¿ã‚¤ãƒ—</h2>
      <div class="grid">
        <label>è³‡æºç•°è³ªæ€§</label><div class="value" id="val_heterogeneity">0.50</div>
        <input type="range" id="heterogeneity" min="0" max="1.0" step="0.05" value="0.50"><div></div>
        <label>å¯¿å‘½å¤‰å‹•</label><div class="value" id="val_lifespanVar">0.30</div>
        <input type="range" id="lifespanVariance" min="0" max="1.0" step="0.05" value="0.30"><div></div>
        <label>æ´»ç”¨ç‰¹åŒ– å‰²åˆ</label><div class="value" id="val_exploiter">0.30</div>
        <input type="range" id="exploiterRatio" min="0" max="1.0" step="0.05" value="0.30"><div></div>
        <label>æ¢ç´¢ç‰¹åŒ– å‰²åˆ</label><div class="value" id="val_explorer">0.30</div>
        <input type="range" id="explorerRatio" min="0" max="1.0" step="0.05" value="0.30"><div></div>
        <label>æˆ¦ç•¥çš„åˆæœŸé…ç½®</label>
        <div><input type="checkbox" id="strategicSpawningEnabled" checked aria-label="æˆ¦ç•¥çš„åˆæœŸé…ç½®ON/OFF"></div>
      </div>
    </section>

    <section class="panel">
      <h2>TRT/PRA åŠ›å­¦</h2>
      <div class="grid">
        <label>TRTå¼·åº¦</label><div class="value" id="val_trt">0.015</div>
        <input type="range" id="trtForce" min="0" max="0.05" step="0.001" value="0.015"><div></div>
        <label>PRAå¼·åº¦</label><div class="value" id="val_pra">0.020</div>
        <input type="range" id="praForce" min="0" max="0.05" step="0.001" value="0.020"><div></div>
        <label>ä¸­å¤®åæŸ</label><div class="value" id="val_central">0.030</div>
        <input type="range" id="centralConvergence" min="0" max="0.10" step="0.001" value="0.030"><div></div>
        <label>ç²’å­å¼•åŠ›</label><div class="value" id="val_peer">0.010</div>
        <input type="range" id="peerAttraction" min="0" max="0.05" step="0.001" value="0.010"><div></div>
      </div>
      <div class="help">TRTç¸¦ç§»å‹•=æ±ºå®šè«–(é«˜ã•ã§æ¸›è¡°)Ã—å€‹æ€§ã€PRAæ¨ªç§»å‹•=ä¹±æ•°æ–¹å‘Ã—é«˜ã•ä¾å­˜å¼·åº¦(ã‚·ãƒ¼ãƒ‰ç®¡ç†)[1]</div>
    </section>

    <section class="panel">
      <h2>ç’°å¢ƒãƒ»æˆåŠŸæ¡ä»¶</h2>
      <div class="grid">
        <label>æˆåŠŸé–¾å€¤(é«˜ã•)</label><div class="value" id="val_threshold">38</div>
        <input type="range" id="successThreshold" min="10" max="60" step="1" value="38"><div></div>
        <label>é ‚ç‚¹å®¹é‡</label><div class="value" id="val_vertexCap">5</div>
        <input type="range" id="vertexCapacity" min="1" max="50" step="1" value="5"><div></div>
        <label>æ¸›è€—ç‡</label><div class="value" id="val_attrition">0.020</div>
        <input type="range" id="attritionRate" min="0" max="0.1" step="0.001" value="0.020"><div></div>
      </div>
    </section>

    <section class="panel">
      <h2>æ¯”è¼ƒãƒ»ãƒãƒƒãƒãƒ»è¼ƒæ­£</h2>
      <div class="grid">
        <label>ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹</label>
        <div><input type="checkbox" id="headless"></div>
        <label>è©¦è¡Œå›æ•°</label>
        <input type="number" id="batchRuns" min="1" max="1000" step="1" value="20">
        <label>æœ€å¤§æ™‚é–“[s]</label>
        <input type="number" id="maxSimTime" min="1" max="100000" step="1" value="120">
      </div>
      <div class="row" style="margin-top:8px;">
        <button class="btn" id="btnRunBatch">ãƒãƒƒãƒå®Ÿè¡Œ</button>
        <button class="btn ghost" id="btnExportBatchCSV">ãƒãƒƒãƒCSV</button>
      </div>
      <div class="help">è¼ƒæ­£ã®ç›®çš„é–¢æ•°: |å®Ÿæ¸¬KGI-ã‚·ãƒŸãƒ¥æˆåŠŸç‡| æœ€å°åŒ–(â€»GAç­‰ã®æœ€é©åŒ–å™¨ã¯å¤–éƒ¨æ¥ç¶šå‰æã®ãƒ•ãƒƒã‚¯æä¾›)[1]</div>
    </section>

    <section class="panel">
      <h2>çµ±è¨ˆ</h2>
      <div class="stat"><span>çµŒéæ™‚é–“[s]</span><strong id="stat_time">0.0</strong></div>
      <div class="stat"><span>ç·ç™ºç”Ÿ</span><strong id="stat_spawned">0</strong></div>
      <div class="stat"><span>ç¨¼åƒä¸­</span><strong id="stat_active">0</strong></div>
      <div class="stat"><span>æˆåŠŸæ•°</span><strong id="stat_success">0</strong></div>
      <div class="stat"><span>æˆåŠŸç‡[%]</span><strong id="stat_rate">0.0</strong></div>
      <div class="stat"><span>å¹³å‡æˆåŠŸæ™‚é–“[s]</span><strong id="stat_tts">-</strong></div>
      <div class="help">CSVã¯æ™‚ç³»åˆ—/é›†è¨ˆã®åŒæ–¹ã‚’å‡ºåŠ›ã€å†ç¾æ€§æ¤œè¨¼ã¨è«–æ–‡å›³è¡¨ä½œæˆã‚’å®¹æ˜“åŒ–[1]</div>
    </section>

    <section class="panel">
      <h2>çµ„ç¹”ãƒ¢ãƒ‡ãƒ«èª¬æ˜</h2>
      <div class="code">
        ä¸­å¤®é›†æ¨©å‹: ä¸Šå±¤é›†ä¸­ãƒ»çµ±ä¸€æ€§é«˜ã€æŸ”è»Ÿæ€§ä½ã€‚åˆ†æ•£è‡ªå¾‹å‹: ç¾å ´è£é‡ãƒ»é©å¿œæ€§é«˜ã€çµ±ä¸€é›£ã€‚ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰: æ–¹é‡ã¯ä¸­å¤®ã€å®Ÿè£…ã¯ç¾å ´[1]
      </div>
    </section>
  </aside>
</div>

<script>
/* ========= ç ”ç©¶æ©Ÿèƒ½ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========= */
// ä¹±æ•°(å†ç¾æ€§) Mulberry32
function Mulberry32(seed) {
  let t = seed >>> 0;
  return function() {
    t += 0x6D2B79F5;
    let r = Math.imul(t ^ (t >>> 15), 1 | t);
    r ^= r + Math.imul(r ^ (r >>> 7), 61 | r);
    return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
  }
}
function makeRNG(seed) {
  const base = Mulberry32(seed);
  return {
    random: () => base(),
    range: (min, max) => min + (max - min) * base(),
    choice: (arr) => arr[Math.floor(base() * arr.length)]
  };
}
function download(filename, text) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([text], {type:'text/plain'}));
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ========= 3Dã‚·ãƒ¼ãƒ³åˆæœŸåŒ–(å††éŒå¤–å½¢ã®ã¿/å´ç·šãªã—/èŠ±ç«ãªã—) ========= */
const viewport = document.getElementById('viewport');
const scene = new THREE.Scene();
scene.background = new THREE.Color(0xf5f7fb);

const camera = new THREE.PerspectiveCamera(60, 1, 0.1, 2000);
camera.position.set(58, 44, 66);
camera.lookAt(0, 20, 0);

const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false });
viewport.appendChild(renderer.domElement);

const amb = new THREE.AmbientLight(0xffffff, 0.9);
scene.add(amb);
const dir = new THREE.DirectionalLight(0xffffff, 0.8);
dir.position.set(70, 120, 40);
dir.castShadow = false;
scene.add(dir);

// å††éŒå¤–å½¢(é€æ˜ãƒ¡ãƒƒã‚·ãƒ¥ã®ã¿ã€ãƒ¯ã‚¤ãƒ¤/å´ç·šãªã—)
const coneHeight = 40;
const coneRadius = 20;
{
  const geo = new THREE.ConeGeometry(coneRadius, coneHeight, 64, 1, true);
  const mat = new THREE.MeshPhongMaterial({
    color: 0x3b82f6, transparent:true, opacity:0.10, depthWrite:false, side:THREE.DoubleSide
  });
  const cone = new THREE.Mesh(geo, mat);
  cone.position.y = coneHeight/2;
  scene.add(cone);

  // åº•é¢ãƒªãƒ³ã‚°(æ§ãˆã‚)
  const ringGeo = new THREE.RingGeometry(coneRadius*0.98, coneRadius, 64);
  const ringMat = new THREE.MeshBasicMaterial({ color:0x3b82f6, transparent:true, opacity:0.3, side:THREE.DoubleSide });
  const ring = new THREE.Mesh(ringGeo, ringMat);
  ring.rotation.x = -Math.PI/2;
  scene.add(ring);

  // åœ°é¢ã®è–„ã„ã‚°ãƒªãƒƒãƒ‰
  const grid = new THREE.GridHelper(200, 40, 0xcbd5e1, 0xe2e8f0);
  scene.add(grid);
}

function resize() {
  const w = viewport.clientWidth || window.innerWidth;
  const h = viewport.clientHeight || window.innerHeight;
  renderer.setSize(w, h);
  camera.aspect = w/h;
  camera.updateProjectionMatrix();
}
window.addEventListener('resize', resize);
resize();

/* ========= ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿/çŠ¶æ…‹ ========= */
const params = {
  seed: 123456,
  timeScale: 0.10,
  spawnInterval: 0.50,
  batchSize: 3,
  initialParticles: 20,

  heterogeneity: 0.50,
  lifespanVariance: 0.30,
  exploiterRatio: 0.30,
  explorerRatio: 0.30,
  strategicSpawningEnabled: true,

  trtForce: 0.015,
  praForce: 0.020,
  centralConvergence: 0.030,
  peerAttraction: 0.010,

  successThreshold: 38,
  vertexCapacity: 5,
  attritionRate: 0.020,

  headless: false,
  batchRuns: 20,
  maxSimTime: 120
};
let RNG = makeRNG(params.seed);

const state = {
  isRunning:false,
  isPaused:false,
  elapsed:0,
  lastSpawn:0,
  totalSpawned:0,
  successCount:0,
  successTimes:[],
  particles:[],
  apexOccupancy:0,
};

/* ========= ç²’å­(è³‡æº)å®šç¾© ========= */
const PType = { STANDARD:'standard', EXPLORER:'explorer', EXPLOITER:'exploiter' };

class Particle {
  constructor() {
    this.id = `${Date.now()}_${Math.floor(RNG.random()*1e9)}`;
    this.type = this.pickType();
    this.position = new THREE.Vector3(0, 0.6, 0);
    this.velocity = new THREE.Vector3(RNG.range(-0.02,0.02), RNG.range(0.01,0.03), RNG.range(-0.02,0.02));
    this.age = 0;
    this.maxAge = 100 * (1 + (RNG.random()-0.5) * params.lifespanVariance * 2);
    this.isActive = true;
    this.hasSucceeded = false;

    const v = (RNG.random()-0.5)*2*params.heterogeneity;
    this.trtAffinity = 1 + (this.type===PType.EXPLOITER ? +v : this.type===PType.EXPLORER ? -v : 0);
    this.praAffinity = 1 + (this.type===PType.EXPLORER ? +v : this.type===PType.EXPLOITER ? -v : 0);

    this.initPositionStrategic();

    const mat = new THREE.MeshPhongMaterial({ color: this.colorForType(), shininess:30 });
    const geom = this.geomForType();
    this.mesh = new THREE.Mesh(geom, mat);
    this.mesh.castShadow = false;
    this.mesh.receiveShadow = false;
    this.mesh.position.copy(this.position);
    if (!params.headless) scene.add(this.mesh);
  }

  pickType() {
    const r = RNG.random();
    if (r < params.exploiterRatio) return PType.EXPLOITER;
    if (r < params.exploiterRatio + params.explorerRatio) return PType.EXPLORER;
    return PType.STANDARD;
  }
  colorForType() {
    if (this.type===PType.EXPLOITER) return 0xef4444;
    if (this.type===PType.EXPLORER)  return 0x10b981;
    return 0x3b82f6;
  }
  geomForType() {
    if (this.type===PType.EXPLORER)  return new THREE.ConeGeometry(0.55, 1.1, 16);
    if (this.type===PType.EXPLOITER) return new THREE.BoxGeometry(0.8,0.8,0.8);
    return new THREE.SphereGeometry(0.55, 16, 16);
  }
  initPositionStrategic() {
    if (!params.strategicSpawningEnabled) {
      const a = RNG.range(0, Math.PI*2);
      const r = RNG.range(0, coneRadius*0.9);
      this.position.set(Math.cos(a)*r, 0.6, Math.sin(a)*r);
      return;
    }
    switch(this.type){
      case PType.EXPLOITER:{
        const a = RNG.range(0, Math.PI*2);
        const r = RNG.range(0, coneRadius*0.5);
        this.position.set(Math.cos(a)*r, 0.6, Math.sin(a)*r);
        break;
      }
      case PType.EXPLORER:{
        const a = RNG.range(0, Math.PI*2);
        const r = RNG.range(coneRadius*0.6, coneRadius*0.95);
        this.position.set(Math.cos(a)*r, 0.6, Math.sin(a)*r);
        break;
      }
      default:{
        const a = RNG.range(0, Math.PI*2);
        const r = RNG.range(0, coneRadius*0.9);
        this.position.set(Math.cos(a)*r, 0.6, Math.sin(a)*r);
      }
    }
  }

  update(dt) {
    if (!this.isActive) return;

    // TRT(ç¸¦): é«˜ã•æ¯”ã§æ¸›è¡°ã€å€‹æ€§ã§é‡ã¿
    const hRatio = this.position.y / coneHeight;
    this.velocity.y += params.trtForce * (1 - Math.min(1, Math.max(0,hRatio))) * this.trtAffinity * dt;

    // PRA(æ¨ª): ãƒ©ãƒ³ãƒ€ãƒ æ–¹å‘ã€å¼·ã•ã¯é«˜ã•ä¾å­˜ã€å€‹æ€§ã§é‡ã¿ï¼ˆã‚·ãƒ¼ãƒ‰RNGã§å†ç¾æ€§ï¼‰
    const theta = RNG.range(0, Math.PI*2);
    const praMag = params.praForce * (0.3 + 0.7*hRatio) * this.praAffinity * dt;
    this.velocity.x += Math.cos(theta) * praMag;
    this.velocity.z += Math.sin(theta) * praMag;

    // ä¸­å¤®åæŸ(åŸç‚¹ã¸)
    const toCenter = new THREE.Vector3(-this.position.x, 0, -this.position.z);
    if (toCenter.lengthSq() > 1e-6) {
      toCenter.normalize().multiplyScalar(params.centralConvergence * dt);
      this.velocity.add(toCenter);
    }

    // æ‘©æ“¦/æ¸›è¡°
    this.velocity.multiplyScalar(0.985);

    // ä½ç½®æ›´æ–°
    this.position.addScaledVector(this.velocity, dt*10);

    // å††éŒå¢ƒç•Œå†…ã¸(åŠå¾„=ç·šå½¢æ¸›è¡°)
    const maxR = Math.max(0.1, coneRadius * (1 - Math.min(1, Math.max(0, this.position.y / coneHeight))));
    const rNow = Math.sqrt(this.position.x*this.position.x + this.position.z*this.position.z);
    if (rNow > maxR) {
      const s = maxR / rNow;
      this.position.x *= s; this.position.z *= s;
    }
    if (this.position.y < 0) this.position.y = 0;

    // æˆå¦ãƒ»å¯¿å‘½
    this.age += dt;
    if (this.position.y >= params.successThreshold && !this.hasSucceeded) {
      if (state.apexOccupancy < params.vertexCapacity) {
        this.hasSucceeded = true;
        this.isActive = false;
        state.apexOccupancy++;
        state.successCount++;
        state.successTimes.push(state.elapsed); // ç¾æ™‚ç‚¹=åˆ°é”æ™‚é–“
        if (!params.headless) this.mesh.material.color.set(0x00ff00);
      }
    }
    if (this.age > this.maxAge || RNG.random() < params.attritionRate * dt) {
      this.dispose();
      return;
    }

    if (!params.headless && this.mesh) {
      this.mesh.position.copy(this.position);
      // é«˜ã•ã§è‰²æ˜åº¦ã‚’å¤‰åŒ–
      const lightness = 1.0 - (this.position.y/coneHeight)*0.6;
      this.mesh.material.color.offsetHSL(0, 0, 0); // no-op placeholder for future mapping
    }
  }

  dispose() {
    this.isActive = false;
    if (this.hasSucceeded && state.apexOccupancy > 0) state.apexOccupancy--;
    if (!params.headless && this.mesh) {
      scene.remove(this.mesh);
      this.mesh.geometry.dispose();
      this.mesh.material.dispose();
      this.mesh = null;
    }
  }
}

/* ========= ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶å¾¡ ========= */
function resetSimulation(full=true) {
  // ç²’å­ç ´æ£„
  state.particles.forEach(p=>p.dispose());
  state.particles.length = 0;
  Object.assign(state, {
    isRunning:false, isPaused:false, elapsed:0, lastSpawn:0,
    totalSpawned:0, successCount:0, successTimes:[], apexOccupancy:0
  });
  RNG = makeRNG(params.seed);
  if (params.initialParticles > 0) spawn(params.initialParticles);
  updateStats();
}
function spawn(n) {
  for (let i=0;i<n;i++){
    if (state.particles.length>2000) break;
    const p = new Particle();
    state.particles.push(p);
    state.totalSpawned++;
  }
}
let lastRAF = 0;
function tick(ts) {
  const now = ts || performance.now();
  const dtReal = (now - (lastRAF||now)) / 1000;
  lastRAF = now;
  if (state.isRunning && !state.isPaused) {
    const dt = Math.max(0, Math.min(0.1, dtReal)) * params.timeScale;
    state.elapsed += dt;
    if ((state.elapsed - state.lastSpawn) > params.spawnInterval) {
      spawn(params.batchSize);
      state.lastSpawn = state.elapsed;
    }
    state.particles.forEach(p => p.update(dt));
    state.particles = state.particles.filter(p => p.isActive);
    updateStats();
  }
  if (!params.headless) renderer.render(scene, camera);
  requestAnimationFrame(tick);
}

/* ========= UIãƒã‚¤ãƒ³ãƒ‰ ========= */
function bindRange(id, key, valId, fmt= (v)=>v.toFixed(2)) {
  const el = document.getElementById(id);
  const val = document.getElementById(valId);
  const update = ()=>{
    params[key] = (el.type==='range' ? parseFloat(el.value) : (el.type==='number'? parseFloat(el.value) : el.value));
    if (val) val.textContent = fmt(params[key]);
  };
  el.addEventListener('input', update);
  update();
}
function bindDirect(id, key) {
  const el = document.getElementById(id);
  const update = ()=>{
    if (el.type==='checkbox') params[key] = el.checked;
    else if (el.type==='number') params[key] = parseFloat(el.value);
    else params[key] = el.value;
  };
  el.addEventListener('input', update);
  update();
}
function bindUI() {
  bindDirect('seed','seed');
  bindRange('timeScale','timeScale','val_timeScale');
  bindRange('spawnInterval','spawnInterval','val_spawnInterval');
  bindRange('batchSize','batchSize','val_batchSize',v=>v.toFixed(0));
  bindRange('initialParticles','initialParticles','val_initialParticles',v=>v.toFixed(0));

  bindRange('heterogeneity','heterogeneity','val_heterogeneity');
  bindRange('lifespanVariance','lifespanVariance','val_lifespanVar');
  bindRange('exploiterRatio','exploiterRatio','val_exploiter');
  bindRange('explorerRatio','explorerRatio','val_explorer');
  bindDirect('strategicSpawningEnabled','strategicSpawningEnabled');

  bindRange('trtForce','trtForce','val_trt',v=>v.toFixed(3));
  bindRange('praForce','praForce','val_pra',v=>v.toFixed(3));
  bindRange('centralConvergence','centralConvergence','val_central',v=>v.toFixed(3));
  bindRange('peerAttraction','peerAttraction','val_peer',v=>v.toFixed(3));

  bindRange('successThreshold','successThreshold','val_threshold',v=>v.toFixed(0));
  bindRange('vertexCapacity','vertexCapacity','val_vertexCap',v=>v.toFixed(0));
  bindRange('attritionRate','attritionRate','val_attrition',v=>v.toFixed(3));

  bindDirect('headless','headless');
  bindDirect('batchRuns','batchRuns');
  bindDirect('maxSimTime','maxSimTime');

  document.getElementById('btnStart').addEventListener('click', ()=>{
    state.isRunning = true; state.isPaused = false;
  });
  document.getElementById('btnPause').addEventListener('click', ()=>{
    state.isPaused = !state.isPaused;
  });
  document.getElementById('btnReset').addEventListener('click', ()=>{
    resetSimulation(true);
  });

  document.getElementById('btnExportCSV').addEventListener('click', ()=>{
    const csv = exportCSV();
    download(`run_${Date.now()}.csv`, csv);
  });
  document.getElementById('btnExportJSON').addEventListener('click', ()=>{
    const txt = JSON.stringify(params, null, 2);
    download(`scenario_${Date.now()}.json`, txt);
  });
  document.getElementById('fileImport').addEventListener('change', (e)=>{
    const f = e.target.files?.;
    if (!f) return;
    const fr = new FileReader();
    fr.onload = ()=>{
      try {
        const obj = JSON.parse(fr.result);
        Object.assign(params, obj);
        // åæ˜ 
        for (const [id,key] of [
          ['seed','seed'], ['timeScale','timeScale'], ['spawnInterval','spawnInterval'],
          ['batchSize','batchSize'], ['initialParticles','initialParticles'],
          ['heterogeneity','heterogeneity'], ['lifespanVariance','lifespanVariance'],
          ['exploiterRatio','exploiterRatio'], ['explorerRatio','explorerRatio'],
          ['trtForce','trtForce'], ['praForce','praForce'], ['centralConvergence','centralConvergence'],
          ['peerAttraction','peerAttraction'], ['successThreshold','successThreshold'],
          ['vertexCapacity','vertexCapacity'], ['attritionRate','attritionRate'],
          ['batchRuns','batchRuns'], ['maxSimTime','maxSimTime']
        ]) {
          const el = document.getElementById(id);
          if (el) el.value = params[key];
          const lab = document.querySelector(`#val_${id}`) || document.getElementById(`val_${key}`);
          if (lab) lab.textContent = (typeof params[key]==='number' ? params[key].toString() : params[key]);
        }
        const ck = document.getElementById('strategicSpawningEnabled');
        if (ck) ck.checked = !!params.strategicSpawningEnabled;
        const hd = document.getElementById('headless'); if (hd) hd.checked = !!params.headless;
        resetSimulation(true);
      } catch(e){ alert('JSONèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'); }
    };
    fr.readAsText(f);
  });

  document.getElementById('btnRunBatch').addEventListener('click', async ()=>{
    const res = await runBatch();
    alert(`ãƒãƒƒãƒå®Œäº†: n=${res.n}, avgSuccess=${(res.avgSuccess*100).toFixed(2)}%, avgTTS=${(res.avgTTS||0).toFixed(2)}s`);
  });
  document.getElementById('btnExportBatchCSV').addEventListener('click', ()=>{
    if (!lastBatch) return alert('å…ˆã«ãƒãƒƒãƒã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
    const csv = exportBatchCSV(lastBatch);
    download(`batch_${Date.now()}.csv`, csv);
  });
}

function updateStats() {
  document.getElementById('stat_time').textContent = state.elapsed.toFixed(1);
  document.getElementById('stat_spawned').textContent = state.totalSpawned.toString();
  const active = state.particles.length;
  document.getElementById('stat_active').textContent = active.toString();
  document.getElementById('stat_success').textContent = state.successCount.toString();
  const rate = state.totalSpawned>0 ? (state.successCount/state.totalSpawned*100) : 0;
  document.getElementById('stat_rate').textContent = rate.toFixed(1);
  const avgTTS = state.successTimes.length>0 ? (state.successTimes.reduce((a,b)=>a+b,0)/state.successTimes.length) : NaN;
  document.getElementById('stat_tts').textContent = isFinite(avgTTS) ? avgTTS.toFixed(2) : '-';
}

/* ========= CSVå‡ºåŠ› ========= */
function exportCSV() {
  const header = [
    'time','totalSpawned','active','success','successRate','avgTTS'
  ];
  const lines = [];
  // ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ1è¡Œ(è»½é‡)
  const rate = state.totalSpawned>0 ? (state.successCount/state.totalSpawned) : 0;
  const avgTTS = state.successTimes.length>0 ? (state.successTimes.reduce((a,b)=>a+b,0)/state.successTimes.length) : '';
  lines.push([state.elapsed.toFixed(3), state.totalSpawned, state.particles.length, state.successCount, rate.toFixed(6), (avgTTS||'')].join(','));
  return header.join(',') + '\n' + lines.join('\n');
}

/* ========= ãƒãƒƒãƒå®Ÿè¡Œ(ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹æ¨å¥¨) ========= */
let lastBatch = null;
async function runBatch() {
  const savedHeadless = params.headless;
  params.headless = true;
  // æç”»åˆ‡ã‚Šæ›¿ãˆ: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå†è¿½åŠ ã‚’é¿ã‘ã‚‹ãŸã‚åœæ­¢ã®ã¿
  const results = [];
  const n = Math.max(1, Math.min(10000, parseInt(params.batchRuns)||1));
  const maxT = Math.max(1, parseFloat(params.maxSimTime)||60);

  for (let i=0;i<n;i++){
    // ä¹±æ•°ã‚·ãƒ¼ãƒ‰ã‚’ãšã‚‰ã™(å†ç¾ã‚»ãƒƒãƒˆã‚’ä½œã‚‹å ´åˆã¯å›ºå®šã®ã¾ã¾ã§ã‚‚è‰¯ã„)
    params.seed = (params.seed + i*977) >>> 0;
    resetSimulation(true);
    state.isRunning = true;
    state.isPaused = false;
    // ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹æ™‚é–“ãƒ«ãƒ¼ãƒ—
    let last = performance.now();
    while (state.elapsed < maxT) {
      const now = performance.now();
      const dtReal = (now - last)/1000;
      last = now;
      const dt = Math.min(0.1, dtReal) * params.timeScale;
      state.elapsed += dt;
      if ((state.elapsed - state.lastSpawn) > params.spawnInterval) {
        spawn(params.batchSize);
        state.lastSpawn = state.elapsed;
      }
      state.particles.forEach(p => p.update(dt));
      state.particles = state.particles.filter(p => p.isActive);
      // æˆåŠŸãŒååˆ†æºœã¾ã‚Œã°æ—©æœŸåœæ­¢
      if (state.successCount >= Math.max(1, params.vertexCapacity)) break;
      // å¿µã®ãŸã‚CPUã‚¦ã‚§ã‚¤ãƒˆã‚’è»½æ¸›
      // await new Promise(r=>setTimeout(r,0));
    }
    const rate = state.totalSpawned>0 ? (state.successCount/state.totalSpawned) : 0;
    const avgTTS = state.successTimes.length>0 ? (state.successTimes.reduce((a,b)=>a+b,0)/state.successTimes.length) : NaN;
    results.push({
      seed: params.seed, successRate: rate, avgTTS: isFinite(avgTTS)?avgTTS:NaN,
      totalSpawned: state.totalSpawned, successes: state.successCount
    });
  }
  params.headless = savedHeadless;
  lastBatch = { n, results };
  return {
    n,
    avgSuccess: results.reduce((a,b)=>a+b.successRate,0)/n,
    avgTTS: (()=> {
      const arr = results.map(r=>r.avgTTS).filter(x=>isFinite(x));
      return arr.length? arr.reduce((a,b)=>a+b,0)/arr.length : NaN;
    })()
  };
}
function exportBatchCSV(batch) {
  const header = ['seed','successRate','avgTTS','totalSpawned','successes'];
  const lines = batch.results.map(r => [r.seed, r.successRate.toFixed(6), isFinite(r.avgTTS)?r.avgTTS.toFixed(4):'', r.totalSpawned, r.successes].join(','));
  return header.join(',') + '\n' + lines.join('\n');
}

/* ========= åˆæœŸåŒ– ========= */
bindUI();
resetSimulation(true);
requestAnimationFrame(tick);
</script>
</body>
</html>
